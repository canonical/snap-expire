#!/bin/sh
email=$1
snapname=$2
ndays=${3:-5}

if [ "$#" -lt 2 ]; then
cat <<EOF
USAGE

  $0 store-email snap-name [number-of-days]

DESCRIPTION

  Outputs the branches that expire in number-of-days (default: 5) in JSON format.

EXIT VALUES

  4 if no branch is to expire in number-of-days;
  0 if one branch is to expire in number-of-days;
  ? if unexpected error occurs.
EOF
exit 21
fi

surl -a x -s production -e "$email" \
  "https://dashboard.snapcraft.io/api/v2/snaps/$snapname/releases" |
jq -e --arg til "$(date --date="today + $ndays days" +%s)" '
[
  .releases[] |
    select((."expiration-date"//empty | fromdateiso8601) > now
       and (."expiration-date"//empty | fromdateiso8601) < ($til | tonumber))
] | unique_by(.channel, .architecture)
# Just sets exit code if no match is found
| select (length>0)'
